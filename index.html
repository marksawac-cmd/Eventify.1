<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QR Code Scanner</title>
  <style>
    :root {
      --bg: #0b1020;
      --panel: #121831;
      --text: #e8ecff;
      --muted: #9aa3bf;
      --accent: #6aa0ff;
      --good: #10b981;
      --bad: #ef4444;
    }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Noto Sans, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: linear-gradient(180deg, var(--bg), #0f1530 60%);
      color: var(--text);
      display: grid; place-items: center; padding: 24px;
    }
    .app { width: min(960px, 100%); }
    .card { background: var(--panel); border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,.35); overflow: hidden; }
    header { padding: 20px 24px; border-bottom: 1px solid rgba(255,255,255,.06); display: flex; gap: 12px; align-items: center; justify-content: space-between; flex-wrap: wrap; }
    header h1 { font-size: clamp(18px, 2.4vw, 22px); margin: 0; font-weight: 700; letter-spacing: .2px; }
    header .actions { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    select, button, input[type="file"]::file-selector-button {
      appearance: none; border: 1px solid rgba(255,255,255,.12); background: #151b39; color: var(--text);
      padding: 10px 12px; border-radius: 12px; font-size: 14px; cursor: pointer;
    }
    button { border: 1px solid rgba(255,255,255,.12); }
    button.primary { background: var(--accent); color: #06122b; font-weight: 700; border: none; }
    button.ghost { background: transparent; }
    button:disabled { opacity: .5; cursor: not-allowed; }
    main { display: grid; gap: 18px; padding: 18px; }
    .preview-wrap { position: relative; aspect-ratio: 16/10; border-radius: 16px; overflow: hidden; background: #0a0f22; }
    video, canvas { width: 100%; height: 100%; object-fit: cover; display: block; }
    .overlay { position: absolute; inset: 0; pointer-events: none; box-shadow:
        0 0 0 200vmax rgba(0,0,0,.35) inset,
        0 0 0 4px rgba(255,255,255,.12) inset;
      border-radius: 16px;
    }
    .finder { position: absolute; inset: 12% 20%; border: 2px dashed rgba(255,255,255,.5); border-radius: 12px; }
    .status { display: flex; gap: 10px; align-items: center; justify-content: space-between; flex-wrap: wrap; }
    .status small { color: var(--muted); }
    .result { background: #0d142c; border: 1px solid rgba(255,255,255,.08); border-radius: 14px; padding: 14px; word-break: break-word; }
    .result.success { border-color: rgba(16,185,129,.4); box-shadow: 0 0 0 1px rgba(16,185,129,.25) inset; }
    .result .label { font-size: 12px; color: var(--muted); letter-spacing: .3px; }
    .result .value { margin-top: 6px; font-size: 14px; line-height: 1.35; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; }
    .row > * { flex: 1 1 auto; }
    .hint { color: var(--muted); font-size: 12px; }
    a.deep { color: var(--accent); text-decoration: none; }
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <header>
        <h1>QR Code Scanner</h1>
        <div class="actions">
          <select id="cameraSelect" title="Choose camera"></select>
          <button id="startBtn" class="primary">Start</button>
          <button id="stopBtn" class="ghost" disabled>Stop</button>
          <label class="ghost" style="display:inline-flex; gap:8px; align-items:center;">
            <input id="beepToggle" type="checkbox" checked /> Beep on scan
          </label>
        </div>
      </header>
      <main>
        <div class="preview-wrap">
          <video id="preview" autoplay muted playsinline></video>
          <div class="overlay"></div>
          <div class="finder"></div>
        </div>
        <div class="status">
          <small id="statusText">Idle. Grant camera permission to start.</small>
          <div class="row" style="justify-content:flex-end;">
            <label class="ghost" style="display:inline-flex; gap:8px; align-items:center;">
              <input id="continuousToggle" type="checkbox" checked/> Continuous scan
            </label>
          </div>
        </div>
        <div id="resultBox" class="result" hidden>
          <div class="label">Result</div>
          <div id="resultValue" class="value"></div>
          <div class="row" style="margin-top:10px;">
            <button id="copyBtn">Copy</button>
            <a id="openLink" class="deep" href="#" target="_blank" rel="noopener" hidden>Open as link ↗</a>
          </div>
        </div>
        <small class="hint">Tip: Works best over HTTPS and in good light. You can also pick an image file to scan.</small>
      </main>
    </div>
  </div>

  <!-- ZXing JS (barcode/QR decoding) -->
  <script src="https://unpkg.com/@zxing/library@0.20.0"></script>
  <script>
    const video = document.getElementById('preview');
    const cameraSelect = document.getElementById('cameraSelect');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const statusText = document.getElementById('statusText');
    const resultBox = document.getElementById('resultBox');
    const resultValue = document.getElementById('resultValue');
    const copyBtn = document.getElementById('copyBtn');
    const openLink = document.getElementById('openLink');
    const beepToggle = document.getElementById('beepToggle');
    const continuousToggle = document.getElementById('continuousToggle');

    const codeReader = new ZXing.BrowserMultiFormatReader();
    let currentDeviceId = null;
    let currentStream = null;
    let torchOn = false;

    async function listCameras() {
      try {
        const devices = await ZXing.BrowserCodeReader.listVideoInputDevices();
        cameraSelect.innerHTML = '';
        devices.forEach((d, idx) => {
          const opt = document.createElement('option');
          opt.value = d.deviceId;
          opt.textContent = d.label || (idx === 0 ? 'Default camera' : `Camera ${idx+1}`);
          cameraSelect.appendChild(opt);
        });
        if (devices.length === 0) {
          const opt = document.createElement('option');
          opt.textContent = 'No camera found';
          opt.value = '';
          cameraSelect.appendChild(opt);
          startBtn.disabled = true;
        }
      } catch (e) {
        console.error(e);
        status(`Could not list cameras. ${e.message}`);
      }
    }

    function status(msg) { statusText.textContent = msg; }

    async function startScan() {
      const deviceId = cameraSelect.value || undefined; // undefined lets the browser pick
      try {
        stopScan(); // reset if already running
        status('Starting camera…');
        startBtn.disabled = true;
        stopBtn.disabled = false;

        // Use ZXing helper to manage stream + decoding
        await codeReader.decodeFromVideoDevice(deviceId, video, (result, err) => {
          if (result) {
            onDecoded(result.getText());
            if (!continuousToggle.checked) {
              stopScan();
            }
          }
        });

        // Save stream reference for torch/stop
        currentStream = video.srcObject;
        currentDeviceId = deviceId || (await getActiveDeviceId());
        status('Scanning… Point a QR code at the camera.');
      } catch (e) {
        console.error(e);
        status(`Failed to start. ${e.message}`);
        startBtn.disabled = false;
        stopBtn.disabled = true;
      }
    }

    function stopScan() {
      codeReader.reset();
      if (currentStream) {
        currentStream.getTracks().forEach(t => t.stop());
      }
      currentStream = null;
      stopBtn.disabled = true;
      startBtn.disabled = false;
      torchOn = false;
      status('Stopped.'); 
    }

    async function getActiveDeviceId() {
      try {
        const tracks = currentStream ? currentStream.getVideoTracks() : [];
        if (tracks[0] && tracks[0].getSettings) {
          const settings = tracks[0].getSettings();
          return settings.deviceId;
        }
      } catch {}
      return null;
    }



    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyeRRdC_p50D_eZRa1Xm0yL07lLDoSZ1oJgSjDOrJTwIzt4SAMl2n6CHe5PwUHxEXq5Mw/exec";

    function onDecoded(text) {
        console.log("Scanned QR:", text);

        // 1. Clean text: remove https/http
        let cleaned = text.replace(/^https?:\/\//, '');

        // 2. Split by "/" into array
        let parts = cleaned.split("/");

        console.log("Parts to store:", parts);

        // 3. Send array to Google Sheets (timestamp will be added by Apps Script)
        fetch(WEB_APP_URL, {
            method: "POST",
            body: JSON.stringify({ values: parts })
        })
        .then(r => r.text())
        .then(msg => console.log("Sheet response:", msg))
        .catch(err => console.error("Error:", err));

        // 4. Show result in the page
        showResult(parts.join(" | "));
        if (beepToggle.checked) beep();
    }




    function showResult(text) {
      resultBox.hidden = false;
      resultBox.classList.add('success');
      resultValue.textContent = text;
      // If it looks like a URL, show quick open link
      try {
        const u = new URL(text);
        if (u.protocol === 'http:' || u.protocol === 'https:') {
          openLink.href = u.href;
          openLink.hidden = false;
        } else {
          openLink.hidden = true;
        }
      } catch {
        openLink.hidden = true;
      }
    }

    function beep() {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'sine'; o.frequency.value = 880; // A5
        o.connect(g); g.connect(ctx.destination);
        g.gain.setValueAtTime(0.0001, ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime + 0.01);
        o.start();
        setTimeout(() => { g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.05); o.stop(ctx.currentTime + 0.07); }, 80);
      } catch {}
    }

    copyBtn.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(resultValue.textContent || '');
        copyBtn.textContent = 'Copied!';
        setTimeout(() => (copyBtn.textContent = 'Copy'), 1000);
      } catch {}
    });

    startBtn.addEventListener('click', startScan);
    stopBtn.addEventListener('click', stopScan);

    cameraSelect.addEventListener('change', () => {
      if (!stopBtn.disabled) startScan();
    });


    // Initialize on load
    (async function init() {
      if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
        status('Tip: Use HTTPS for camera access in most browsers.');
      }
      await listCameras();
    })();

  </script>
</body>
</html>
